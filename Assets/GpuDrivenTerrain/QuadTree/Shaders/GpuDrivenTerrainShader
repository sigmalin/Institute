Shader "GpuDriven/GpuDrivenTerrainShader"
{
    Properties
    {
    }
    SubShader
    {
        Tags { "RenderType" = "Opaque" "RenderPipeline" = "UniversalPipeline" }
        LOD 100

        Pass
        {
            Name "Opaques"

            HLSLPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            #pragma target 4.5  // for compute shader support

            #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"

            #include "../../Noise/TerrainNoise.hlsl"

            #include "GpuDrivenTerrainCore.hlsl"   

            #if SHADER_TARGET >= 45
            StructuredBuffer<RenderPatch> CulledPatchList;
            #endif

            struct v2f
            {
                float4 vertex : SV_POSITION;
            };

            v2f vert(appdata v, uint instanceID : SV_InstanceID)
            {
                v2f o;

#if SHADER_TARGET >= 45
                RenderPatch data = CulledPatchList[instanceID];
#else
                RenderPatch data = 0;
#endif

                float3 position = TransformLocalToWorld(v, data);

                o.vertex = mul(unity_MatrixVP, float4(position, 1));
                return o;
            }

            half3 frag(v2f i) : SV_Target
            {
                return 1;
            }
            ENDHLSL
        }

        Pass
        {
            Name "Wireframe"

            Cull Off
            ZTest Always

            HLSLPROGRAM
            #pragma vertex vert
            #pragma geometry geom
            #pragma fragment frag

            #pragma target 4.5  // for compute shader support
            #pragma require compute
            #pragma require instancing
            #pragma require geometry

            #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"

            #include "../../Noise/TerrainNoise.hlsl"

            #include "GpuDrivenTerrainCore.hlsl"   

            #if SHADER_TARGET >= 45
            StructuredBuffer<RenderPatch> CulledPatchList;
            #endif

            struct v2g
            {
                float4 vertex : POSITION;
            };

            struct g2f
            {
                float4 vertex : SV_POSITION;
            };

            v2g vert(appdata v, uint instanceID : SV_InstanceID)
            {
                v2g o;

#if SHADER_TARGET >= 45
                RenderPatch data = CulledPatchList[instanceID];
#else
                RenderPatch data = 0;
#endif

                float3 position = TransformLocalToWorld(v, data);

                o.vertex = mul(unity_MatrixVP, float4(position, 1));
                return o;
            }

            [maxvertexcount(6)]
            void geom(triangle v2g input[3], inout LineStream<g2f> lineStream)
            {
                g2f o1, o2, o3;

                o1 = input[0];
                o2 = input[1];
                o3 = input[2];

                lineStream.Append(o1);
                lineStream.Append(o2);
                lineStream.RestartStrip();

                lineStream.Append(o2);
                lineStream.Append(o3);
                lineStream.RestartStrip();

                lineStream.Append(o3);
                lineStream.Append(o1);
                lineStream.RestartStrip();
            }

            half3 frag(g2f i) : SV_Target
            {
                return 0;
            }
            ENDHLSL
        }

        Pass
        {
            Name "Debug"

            HLSLPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            #pragma target 4.5  // for compute shader support

            #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"

            #include "../../Noise/TerrainNoise.hlsl"

            #include "GpuDrivenTerrainCore.hlsl"   

            #if SHADER_TARGET >= 45
            StructuredBuffer<RenderPatch> CulledPatchList;
            #endif

            struct v2f
            {
                float4 vertex : SV_POSITION;
                half3 color : COLOR;
            };

            v2f vert(appdata v, uint instanceID : SV_InstanceID)
            {
                v2f o;

#if SHADER_TARGET >= 45
                RenderPatch data = CulledPatchList[instanceID];
#else
                RenderPatch data = 0;
#endif

                float3 position = TransformLocalToWorld(v, data);
                position.y = getHeight(position.xz);

                o.color = (getNormal(position.xz, position.y).rbg + 1) * 0.5;
                o.vertex = mul(unity_MatrixVP, float4(position, 1));                
                return o;
            }

            half3 frag(v2f i) : SV_Target
            {
                return i.color;
            }
            ENDHLSL
        }
    }
}
